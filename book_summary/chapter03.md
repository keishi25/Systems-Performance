# Chapter 03: オペレーティングシステム

# おもしろいポイント
システムコール。
アプリが、ファイル操作するときの仕組みが分かった。
アプリが、システムコールのプロトコルに従って、カーネルに指示をだして、ファイルオープンや通信を行っていることが分かった。
アプリ側の場合は、システムライブラリ（仮想マシン内のAPI(java)やライブラリ(python)）の中で、システムコールを呼び出している。
systemcallについては、manページに記載されている。



3.2.1.1
カーネルコンテキスト
カーネルモードの状態のこと。

コンテクストスイッチ
→cpuで実行するスレッドやプロセスをOSが決めるかきめて、適宜切り替えてること。

カーネルバイパス
→通常とは異なり、ユーザーモードのプログラムがカーネルを通さず、ハードウェア操作できる


割り込みマスキング
→カーネルは適宜、システム安定化のために割り込みされないようにすることが可能。
カーネルが判断するとあるが、どのような判断基準で行っているかよくわからなかった。

おもしろい3.26.1
・通常プロセスはメモリ空間が独立しているが、親子のプロセス環形の時は、COWの戦略がで起用されるため、メモリ空間を共有でき、必要なときになってはじめて、メモリ空間がこぴーされるため、無駄なコピーが発生せず、パフォーマンスがあげられる。
・この戦略は、別の設計の時にも活かせそう。

## 3.7 練習問題

### 1. OS 用語についての問い
- プロセス、スレッド、タスクの違いは何か。  
- モードスイッチとコンテキストスイッチとは何か。  
- ページングとスワッピングの違いは何か。  
- I/O バウンドワークロードと CPU バウンドワークロードの違いは何か。  
バウンド=縛られる。例。「その資源によって性能が制限されている状態」
 I/O バウンドワークロード＝I/Oがボトルネックになっているワークロード
 CPU バウンドワークロード=cpu処理がボトルネックになっているワークロード


### 2. コンセプトについての問い
- カーネルの役割を説明しなさい。  
- システムコールの役割を説明しなさい。  
- VFS の役割と I/O スタック内での位置を説明しなさい。  

### 3. 難易度の高い問い
- スレッドが CPU を手放す理由を列挙しなさい。  
ディスクやネットワークなどの I/O を待つ間は、スレッドは実行できる処理がないため、CPUを使わず、OSによって実行状態から外される（＝CPUを手放す）。
この場合は、アプリ側で例外は発生せず、waiting状態になる。つまり、再び単にレイテンシーが悪くなるだけ。
cpuのスレッド状態とつながったのは面白いと感じた。

- 仮想メモリとデマンドページングの利点を説明しなさい。  



#### 回答
- スレッドが CPU を手放す理由
  - タイムスライス満了によりプリエンプトされる（スケジューラによる切り替え）。
  - I/O 待ちに入る（ディスク・ネットワーク・端末などの待機）。
  - 同期プリミティブ待ちに入る（ミューテックス/セマフォ/条件変数の待機）。
  - ページフォルト処理のために停止する（必要なページを読み込む間の待ち）。
  - 高優先度スレッドへの割り込みでプリエンプトされる。
  - 明示的にスケジューリングを譲る（yield など）。

- 仮想メモリとデマンドページングの利点
  - 仮想メモリ
    - 各プロセスに独立したアドレス空間を提供し、保護と隔離を実現する。
    - 物理メモリ容量以上の大きなアドレス空間を扱える。
    - 連続した仮想アドレスを提供し、プログラムの配置や管理を簡単にする。
    - 共有ライブラリやメモリマップ I/O を効率よく共有できる。
  - デマンドページング
    - 実際に使うページだけ読み込むため、起動時間とメモリ使用量を削減できる。
    - 物理メモリ不足時に必要なページのみを入れ替えることで、スループットを向上できる。
    - アクセスされないコード/データの読み込みを遅延でき、I/O コストを抑えられる。
